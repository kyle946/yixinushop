<layout name="layout/layout_null" />
<script src="<?php echo __ROOT__; ?>static/screenshot-paste.js" type="text/javascript"></script>
<script src="<?php echo __ROOT__; ?>static/jquery.serializejson.min.js" type="text/javascript"></script>
<div class="w1 clearfix" > 
    
    <div class="h10 w100" ></div>
    <form method="post" action="" id="form2" >
        <div class="register_area1 clearfix" >
            <!--<div class="title" >{$webconfig.webtitle} - 商户注册</div>-->
            <div class="title" >商户登录</div>
            <div class="h10 w100" ></div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>手机号码：</div>
                <div class="a2" > <input type="text" name="mobile" value="" /> </div>
                <div class="a3" ><span id="mobiletips" >11位数字的手机号码！</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>登录密码：</div>
                <div class="a2" > <input type="password" name="pwd" value="" /> </div>
                <div class="a3" ><span id="pwdtips" ></span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>图片验证码：</div>
                <div class="a2" >
                    <input type="text" onblur="ch.onecheck(this,rootPath+'u/checkVerify/verifystr/'+this.value,'图片验证码不正确！');" name="yzm" id="yzm" value="" />&nbsp;&nbsp;&nbsp; 
                    <a href="javascript:obj.getverify()" style="display: block; float: right;" >
                        <img border="0" title="点击更换图片" id="yzmi" class="yzmi" src="/u/verifyCode">
                    </a>
                </div>
                <div class="a3" ><span id="yzmtips" >填写图片中的字符，点击图片更换验证码</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ></div>
                <div class="a2" >
                    <button type="button" class="bt1 submit2" style="width:120px;border:0px;" onclick="obj.bus_login()">立即登录</button>
                </div>
                <div class="a3" ></div>
            </div>
        </div>
    </form>
    
    <form method="post" action="" id="form1" >
        <div class="register_area1 clearfix" >
            <!--<div class="title" >{$webconfig.webtitle} - 商户注册</div>-->
            <div class="title" >商户注册</div>
            <div class="h10 w100" ></div>
            <div class="errorinfo" style="background-color: #FFE1BE; color:#f00; padding: 10px; display: none;" >注册失败 ！ 原因可能是手机号已经被注册，或者验证码不正确。</div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>手机号码：</div>
                <div class="a2" > <input type="text" onblur="ch.onecheck(this, rootPath + 'u/business_check_mobile/mobile/' + this.value, '该手机号已注册商户，请更换！',obj.setsendmsgbutton)" name="username" value="" /> </div>
                <div class="a3" ><span id="usernametips" >11位数字的手机号码！</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>登录密码：</div>
                <div class="a2" > <input type="password" onblur="ch.onecheck(this);" name="password" value="" /> </div>
                <div class="a3" ><span id="passwordtips" >6 - 16个字符 ，区分大小写</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>确认密码：</div>
                <div class="a2" > <input type="password" onblur="ch.onecheck(this);" name="password2" value="" /> </div>
                <div class="a3" ><span id="password2tips" >请再次填写密码</span></div>
            </div>
            
            <!--        <div class="row" >
                        <div class="a1" ><font>*</font>手机号码：</div>
                        <div class="a2" > <input type="text" name="mobile" value="" /> </div>
                        <div class="a3" ><span id="mobiletips" >11位数字的手机号码</span></div>
                    </div>-->
            
            <!--        <div class="row" >
                        <div class="a1" >邮箱：</div>
                        <div class="a2" > <input type="text" name="mail" value="" /> </div>
                        <div class="a3" >有效的邮件地址</div>
                    </div>-->
            
            <div class="row" >
                <div class="a1" ><font>*</font>商户名称：</div>
                <div class="a2" > <input type="text" style="color:#888" onblur="ch.onecheck(this);" name="bname" value="" /></div>
                <div class="a3" ><span id="bnametips" > 1 - 16个中文或英文或数字组成的商户名称</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>主体信息：</div>
                <div class="a2" > <input type="text" style="color:#888" onblur="ch.onecheck(this);" name="si" value="" /></div>
                <div class="a3" ><span id="sitips" > 商户的主体信息，如公司名称</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>真实姓名：</div>
                <div class="a2" > <input type="text" style="color:#888" onblur="ch.onecheck(this);" name="aname" value="" /></div>
                <div class="a3" ><span id="anametips" > 商户负责人的真实姓名</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>身份证号码：</div>
                <div class="a2" > <input type="text" style="color:#888" onblur="ch.onecheck(this);" name="idnumber" value="" /></div>
                <div class="a3" ><span id="idnumbertips" > 请填写有效的身份证号码</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ><font>*</font>证件照片：</div>
                <div class="a2" > <input type="text" style="color:#888" id="imagepaste" name="image" value="" /></div>
                <div class="a3" ><span id="idnumberimgtips" > 手持证件半身照 (使用QQ或微信截图后 CTRL+V 即可)</span></div>
            </div>
            
            <div class="row" >
                <div class="a1" >&nbsp;</div>
                <div  id="imgPreview" style='width:480px; height: 230px; border:1px solid #f1f1f1;display: inline-block;'></div>
            </div>
<script>
    $('#imagepaste').screenshotPaste({
        imgContainer:'#imgPreview'
    });
</script>
            
            
            <!--        <div class="row" >
                        <div class="a1" ><font>*</font>图片验证码：</div>
                        <div class="a2" >
                            <input type="text" onblur="ch.onecheck(this,rootPath+'u/checkVerify/verifystr/'+this.value,'图片验证码不正确！');" name="yzm" id="yzm" value="" />&nbsp;&nbsp;&nbsp; 
                            <a href="javascript:obj.getverify()" ><img border="0" title="点击更换图片" id="yzmi" class="yzmi" src="/u/verifyCode"></a>
                        </div>
                        <div class="a3" ><span id="yzmtips" >填写图片中的字符，点击图片更换验证码</span></div>
                    </div>-->
            
            <div class="row" id="setsendmsgbutton" style="display: none;" >
                <div class="a1" ><font>*</font>短信验证码：</div>
                <div class="a2" > <input type="text" style="color:#888" onblur="ch.onecheck(this,rootPath+'u/checkVerifyMsg/verifystr/'+this.value,'验证码不正确！');" name="yzm2" id="yzm2" value="" /></div>
                <div class="a3" >
                    <input type="button" class="bt1" id="button1"  value="发送短信验证码" onclick="obj.sendmsg()" />&nbsp;&nbsp;<span id="yzm2tips" ></span>
                </div>
            </div>
            
            <div class="row" >
                <div class="a1" ></div>
                <div class="a2" >
                    <input style="padding: 0px; width: auto;" type="checkbox" name="protocol" value="1" />
                    同意&nbsp;&nbsp;<a href="javascript:void(0)" >商户注册协议</a>
                </div>
                <div class="a3" ><span id="protocoltips" ></span></div>
            </div>
            
            <div class="row" >
                <div class="a1" ></div>
                <div class="a2" >
                    <button type="button" class="bt1 submit2" style="width:120px;border:0px;" onclick="obj.submit()">立即注册</button>
                </div>
                <div class="a3" ></div>
            </div>
            
<!--            <div class="row" >
                <div class="a1" ></div>
                <div class="a2" ><a href='<root />u/login' >我有商户号，现在去登录</a></div>
                <div class="a3" ></div>
            </div>-->
            
        </div>
    </form>
    <div class="h10 w100" ></div>
    <div class="h10 w100" ></div>
</div>

<script>
    obj = {};
    $(function() {
    var option = new Array();
    option[0] = {name: 'username', type: 'mobile', msg: '请填写有效的手机号码！', required: 1};
    option[1] = {name: 'bname', type: 'regexp',  msg: '1到22个字符，不能包含： < > \ = / . ? \'  | & \" ! @ # $ % *', rule: /^[^<>\\=/.?+'|&\"!@#$%*]{1,22}$/, required: 1};
    option[2] = {name: 'si',type:'regexp', msg: '1到35个字符，不能包含： < > \ = / . ? \'  | & \" ! @ # $ % *', rule: /^[^<>\\=/.?+'|&\"!@#$%*]{1,35}$/, required: 1};
    option[3] = {name: 'aname',type:'regexp', msg: '1到16个字符，不能包含： < > \ = / . ? \'  | & \" ! @ # $ % *', rule: /^[^<>\\=/.?+'|&\"!@#$%*]{1,16}$/, required: 1};
    option[4] = {name: 'idnumber',type:'regexp', msg: '请输入正确的身份证号码！', rule: /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/, required: 1};
    
    option[5] = {name: 'password', type: 'password', msg: '6 - 16个字符 ，区分大小写！', required: 1};
    option[6] = {name: 'password2', type: 'password2', msg: '两次密码输入不一致！'};
    option[7] = {name: 'yzm2', type: 'regexp', msg: '请填写正确的验证码！', rule: /^.{6,6}$/, required: 1};
    option[8] = {name: 'protocol', type: 'check', msg: '请阅读并同意 商户注册协议！'};
    ch = new formCheck(option);
    });
    
    obj.setsendmsgbutton = function(s){
        if(s==1){
            document.getElementById('setsendmsgbutton').style.display = 'block';
        }else{
            document.getElementById('setsendmsgbutton').style.display = 'none';
        }
    };

    //--检测字段
    function icheck() {
        var bool_ = false;
        var res = ch.start();
        if (res == 1) {
            bool_ = true;
        }
        return bool_;
    }
    
    obj.submit = function(){
        if( icheck() ){
            var data = $("#form1").serializeJSON();
            data.image = $("#imgPreview img").attr('src');
            $.ajax({
                url:"<root />u/business_register",
                type:"POST",
                data:data,
                dataType:"text",
                beforeSend:function(){
                    $("#form1 button.submit2").text("正在注册…").attr('disabled','disabled');
                },
                error:function(){
                    $(".errorinfo").text("注册发生错误！").css({display:'block'});
                    $("#form1 button.submit2").text("立即注册").removeAttr('disabled');
                },
                success:function(d){
                    if(d!=1){
                        $(".errorinfo").text(d).css({display:'block'});
                    } else if(d==1){
                        //--confirm_("商户申请注册成功,正在等待审核。");
                        window.location.href = "/u/business_info";
                    }
                }
            });
        }
    };
    
    obj.bus_login = function(){
            var mobile = $("#form2 input[name=mobile]").val();
            var rule = new RegExp(/^0?1[3|4|5|8|7][0-9]\d{8}$/);
            if( !rule.test(mobile) ){
                document.getElementsByName("mobile").item(0).focus();
                document.getElementById("mobiletips").style.color = '#f00';
                document.getElementById("mobiletips").innerHTML='请填写一个有效的手机号码！';
                return false;
            }
            var pwd = $("#form2 input[name=pwd]").val();
            if(pwd==''){
                document.getElementById("pwdtips").style.color = '#f00';
                document.getElementById("pwdtips").innerHTML='请输入密码！';
                return false;
            }
            var pwd = $("#form2 input[name=yzm]").val();
            if(pwd==''){
                document.getElementById("yzmtips").style.color = '#f00';
                document.getElementById("yzmtips").innerHTML='请输入验证码！';
                return false;
            }
            $.ajax({
                url:"<root />u/business_login",
                type:"POST",
                data: $("#form2").serialize(),
                dataType:"text",
                error:function(){
                    $(".errorinfo").text("查询错误！！").css({display:'block'});
                },
                success:function(d){
                    if(d!=1){
                        confirm_(d);
                    }else{
                        window.location.href = "/u/business_info";
                    }
                }
            });
    };

    //--更新验证码
    obj.getverify = function() {
        var imgyzm = document.getElementById('yzmi');
        imgyzm.setAttribute('src', "<root />u/verifyCode/rand_" + Math.random());
    };

    //--发送短信验证码
    obj.sendmsg = function() {
        var mobile = document.getElementsByName('username').item(0).value;
        $.get("<?php echo createLink('u/sendmsg'); ?>" + 'mobile/' + mobile, function(d) {
            if (d.status == 1) {
                var note1 = document.getElementById('button1');
                note1.style.backgroundColor = '#646464';
                var wait = 120;
                var interval = setInterval(function() {
                    var time = --wait;
                    document.getElementById('button1').value = '发送短信验证码 ' + wait;
                    if (time == 0) {
                        var note1 = document.getElementById('button1');
                        note1.setAttribute("disabled", false);
                        note1.style.backgroundColor = '#CA0000';
                        clearInterval(interval);
                    }
                }, 1000);
            } else {
                confirm_(d.msg, null, 300, 80);
            }
        }, 'json');
    };
</script>

